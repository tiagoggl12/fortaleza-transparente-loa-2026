name: Performance & Accessibility

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    - cron: '0 0 * * 1'  # Weekly on Monday

env:
  NODE_VERSION: '22'

jobs:
  # Lighthouse CI for performance monitoring
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Serve application
        run: |
          npx serve -s dist -l 3000 &
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            http://localhost:3000
            http://localhost:3000/?view=revenue
            http://localhost:3000/?view=expense
            http://localhost:3000/?view=regional
            http://localhost:3000/?view=participatory
          uploadArtifacts: true
          temporaryPublicStorage: true
          budgetPath: ./.github/lighthouse-budget.json
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

      - name: Performance comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const resultsPath = '.lighthouseci/results.json';
            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const summary = results.map(r => {
                const url = new URL(r.url).pathname;
                return `**${url}** - Performance: ${r.scores.performance}/100`;
              }).join('\n');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## Lighthouse Results\n\n${summary}`
              });
            }

  # Accessibility testing with axe-core
  accessibility:
    name: Accessibility Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Serve application
        run: |
          npx serve -s dist -l 3001 &
          npx wait-on http://localhost:3001 --timeout 60000

      - name: Run accessibility tests
        run: |
          npm install -D @axe-core/cli
          npx axe http://localhost:3001 --tags wcag2a,wcag2aa,best-practice || true

      - name: Run axe-core with Playwright
        run: |
          npx playwright install --with-deps chromium
          npx playwright test --project=chromium --grep=@a11y || true

      - name: Upload a11y results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-results
          path: a11y-results/
          retention-days: 30

  # Bundle size analysis
  bundle-size:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Analyze bundle size
        run: |
          npm install -g bundlesize
          npx bundlesize || true

      - name: Compare with base branch
        if: github.event_name == 'pull_request'
        run: |
          git checkout ${{ github.event.pull_request.base.sha }}
          mkdir -p dist-base
          cp -r dist/* dist-base/ || true
          git checkout -

          echo "## Bundle Size Comparison" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Base | PR | Diff |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|-----|------|" >> $GITHUB_STEP_SUMMARY

          for file in dist/**/*.{js,css}; do
            if [ -f "$file" ]; then
              base_name=$(basename "$file")
              base_size=$(stat -f%z "dist-base/$base_name" 2>/dev/null || echo 0)
              new_size=$(stat -f%z "$file" 2>/dev/null || echo 0)
              diff=$((new_size - base_size))
              printf "| %s | %d | %d | %s%d |\n" "$base_name" "$base_size" "$new_size" \
                "$([ $diff -ge 0 ] && echo '+' || echo '')" "$diff" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        with:
          name: bundle-analysis
          path: dist/
          retention-days: 30

  # Core Web Vitals monitoring
  core-web-vitals:
    name: Core Web Vitals
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run pagespeed insights
        uses: JustAGithubUser/pagespeed-insights-action@v1
        with:
          url: https://fortaleza-transparente-ploa-2026.vercel.app/
          googleApikey: ${{ secrets.PAGESPEED_API_KEY }}
        continue-on-error: true

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pagespeed-results
          path: pagespeed-results/
          retention-days: 30
